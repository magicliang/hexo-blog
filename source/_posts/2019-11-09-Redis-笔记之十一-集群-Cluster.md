---
title: Redis 笔记之十一-集群 Cluster
date: 2019-11-09 19:13:46
tags:
- Redis
---
# 背景
在 Redis Cluster 方案诞生以前，在 Redis 集群遇到单机资源和流量瓶颈时，有两种常见分布式解决方案：

- 客户端方案：需要自己处理分区逻辑、路由、故障转移。
- 代理方案：减轻了客户端的职责和压力，架构上的负担过重。

Redis Cluster 的出现，极大地降低了架构师的负担，解放了生产力。

# 数据分布

## 数据分布理论

|分区方式|特点|代表产品|
|:--:|:--:|:--:|
|哈希分区| 离散度好 数据分布业务无关 无法顺序访问| **KV型** Redis Cluster Cassandra Dynamo **Elastic Search**|
|顺序分区|离散度易倾斜 数据分布业务相关 可顺序访问| **表型 Bigtable** HBase Hypertable|

由于 Redis Cluster 采取哈希分区规则，常见的哈希分区规则有

### 节点取余分区

使用特定的数据，如 Redis 的键或用户 Id，再根据节点数量 N 使用公式：`hash(key)% N`（经典的双层 hash），用来决定数据映射到哪一个桶里。这种方案存在一个问题，当节点数量变化时，整个映射关系都要重新计算。

如果使用这种哈希方式，一开始就要规划好分区，保证可以支撑**未来一段时间的数据量**，扩容时可以天然采用翻倍扩容。

### 一致性哈希

一致性哈希（Distributed Hash Table）的实现思路是为系统中每个节点分配一个 token，范围一般在 0~2 power 32，这些 token 构成一个 hash 环。数据读写执行查找时，先 hash，然后顺时针（向大数方向）选最近一个 bucket。

![一致性散列.jpg](一致性散列.jpg)

一致性散列的好处在于加入和删除节点只影响哈希环中相邻的节点，对其他节点无影响。但一致性哈希分区存在几个问题：

- 加减节点会造成哈希环中部分数据无法命中（取余分区一样存在这个问题），需要手动处理或者忽略这部分数据，因此一致性哈希常用于缓存场景。
- 当使用少量节点时，节点变化将大范围影响哈希环中数据映射，因此这种方式不适合少量数据节点的分布式方案。
- 普通的一致性哈希分区在增减节点时需要增加一倍或减去一般节点才能保证数据和负载的均衡。

### 虚拟槽分区

虚拟槽分区兼顾了取余分区和一致性哈希的优点，使用分散度良好的哈希函数把所有数据映射到一个固定范围的整数集合中，整数定义为槽（slot）。这个数一般远大于节点数，比如 Redis Cluster 的槽范围是 0 -16383。槽是集群内数据管理和迁移的基本单位。采用大范围的槽的目的是为了方便数据拆分和集群扩展，每个节点负责一定数量的槽。

## Redis 数据分区

slot = crc16(key) * 16383 

注意：
- crc16 是一种哈希函数
- 用 * 取余的方法

每个节点负责维护一部分槽以及槽锁映射的键值数据。

![Redis Cluster 的槽位映射.jpg](Redis Cluster 的槽位映射.jpg)

Redis 虚拟槽分区的特点：

- 解耦数据和几点之间的关系，简化了节点扩容和收缩难度。
- 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据。
- 支持节点、槽、键之间的映射查询，用于数据路由、在线伸缩等场景。

## Redis 数据分区限制

1. 只允许对映射到同一个 slot 的 key 进行批量操作，如 mget、mset。
2. 只支持对映射到同一个 node 的 key 进行事务操作。
3. 大数据结构（hash/list）必须映射到同一节点（key 在最小的可分割单位）。
4. 不支持多数据空间，只能使用 db0。有了 Redis Cluster，会推动多数据空间消亡。
5. 复制结构只支持一层，从节点只能复制主节点。

# 搭建集群

## 准备节点

Redis Cluster 至少需要 6 个节点。
开启配置`redis-enabled yes`。

准备配置文件：

```bash
daemonize yes #开启后台运行
port 8001 #工作端口
bind 172.16.0.15 #绑定机器的内网IP,一定要设置呀老铁，不要用127.0.0.1
dir /usr/local/redis-cluster/8001/ #指定工作目录，rdb,aof持久化文件将会放在该目录下，不同实例一定要配置不同的工作目录
cluster-enabled yes #启用集群模式
cluster-config-file nodes-8001.conf #生成的集群配置文件名称，集群搭建成功后会自动生成，在工作目录下
cluster-node-timeout 5000 #节点宕机发现时间，可以理解为主节点宕机后从节点升级为主节点时间
appendonly yes #开启AOF模式
pidfile /var/run/redis_8001.pid #pid file所在目录
```


