---
title: 如何写一个消息队列
date: 2021-07-07 19:52:26
tags:
- 消息队列
---
# 重平衡问题

标准的重平衡算法是 kafka 的重平衡算法。

# 积压问题

可能出现积压的几种原因：
1. 客户端没有正确启动。
2. 客户端虽然启动了，但出现消息卡单。
3. 消费能力不足：更下游有些慢阻塞操作，阻塞了 ConsumerFetcherThread ，特别是更下游如果有阻塞服务的话问题更大。

# 延迟问题

## 消费组级延迟

消费组延迟生效在消费端，大概原理可以理解为客户端收到消息之后延迟一定时间之后再调用业务消费逻辑进行消费。

这种方法的实现通常不用改代码，但可能需要消费端有个缓冲区。如果缓冲区的大小固定，则消息可能会丢失。

## 消息级延迟

消息粒度延迟的原理大概是客户端在发送消息之后，不会马上发送到broker,而是先把消息暂存到带有 zset 之类的数据结构的 kv 存储中，等延时时间到达才正式发送消息到broker。每条消息的延迟时间可以不同，通过代码控制。




